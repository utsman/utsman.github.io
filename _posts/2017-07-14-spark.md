---
layout: post
title: spark
category: spark
tags: [spark]
---


# Spark

> Spark는 빠르고 일반적인 범용 클러스터 컴퓨팅 시스템입니다. Java, Scala, Python 및 R의 고급 API와 일반 실행 그래프를 지원하는 최적화 된 엔진을 제공합니다. 또한 SQL 및 구조화 된 데이터 처리를위한 Spark SQL, 기계 학습을위한 MLlib, 그래프 처리를위한 GraphX 및 Spark Streaming을 비롯한 다양한 고급 도구 세트를 지원합니다.

- 장점
	- rdd 개념에 따라 메모리에 데이타를 투명하게 저장하기 때문에, 디스크에 대한 읽기, 쓰기 작업에 따른 시간 소비를 줄일 수 있다.
	- 다중 언어 지원
	- 지연연산(lazy evaluation) 을 사용해서 기초 데이터에 적용될 변환연산을 기억하고 있고 동작(Action) 이 실행될 때 한번에 실행되어, 최적화가 가능하다.
- 단점
	- 완전한 실시간 처리를 지원하지 않는다.
	- 자체 파일 관리 시스템이 없다. (hdfs 같은 시스템에 의존.)

## 구조

![cluster-overview](/public/img/cluster-overview.png "cluster-overview")

## 특징

### RDD

> 탄력적인 분산 데이터 세트 ( Resilient Distributed Datasets ) ,
스파크 마스터 / 드라이버는 RDD에 적용된 변환을 기억하므로 파티션이 손실되면 (예 : 슬레이브 머신이 다운 된 경우) 해당 파티션을 클러스터의 다른 머신에서 쉽게 재구성 할 수 있다.

- 여러 분산 노드에 걸쳐서 저장되는 변경 불가능한 데이타의 집합
	- 불변성으로 인해, 프로세스간의 공유 및 복구 문제를 해결한다.
- 각 RDD 는 클러스터 각 노드들에서 연산 가능하도록 여러개의 파티션으로 나뉜다.
	- RDD의 모든 데이터 세트는 여러 서버에 논리적으로 분할되어 클러스터의 다른 노드에서 계산할 수 있습니다
- RDD 는 트랜스포메이션, 액션이라는 2가지 타입의 연산을 갖는다.
- 액션이 실행될 때는 lazy 연산으로 동작한다.

### DATAFRAME

- 컬럼이 존재하는 분산 컬렉션
- 구조화 된 테이터 처리를 위한 기능을 제공한다.
	- sql 등을 사용하여 데이터를 join 하고, 추출 가능하다.
- RDD 에 비해 2가지의 장점을 가지고 있다.
	- 사용자 정의 메모리 관리
	- 최적화된 실행 계획
		- 내부적인 동작 방식에는 Catalyst Optimizer를 통해 실행 시점에 최적화된 코드를 제공하고 있어 RDD 프로그래밍과 달리 언어(Scala, Java, Pytho, R)에 상관없이 동일한 성능을 보장한다.

### DATASET

- 2.0 부터 DdtaFrame API 가 Dataset 으로 합쳐지게 되었다.
- 인코더를 사용하여, 비구조화, 구조화된 데이타를 모두 다룰 수 있다.
- JVM객체에 대한 바인딩으로 Encoder를 사용하여 유형별 JVM객체를 Tungsten의 내부 메모리 표현으로 매핑하게 된다. 결과적으로 Encoder를 통해 JVM객체를 효율적으로 직렬화/비직렬화 할 수 있으며 소형의 바이트 코드를 생성하게 됨으로 이는 cache size 축소 및 처리시간 관련 성능상 이점을 가질 수 있다.
-  데이터를 off-heap storage에 binary 형태로 시리얼라이즈 하며 여러 트랜스포메이션을 off-heap 메모리상에서 직접 가능하도록 설계되어있다. (스파크에 내장된 엔코더는 off-heap data 와 de-serialize 없이 바로 인터렉트 가능한 바이트코드를 생성할 수 있다)

### 드라이버

- 사용자의 main() 메서드를 실행한다.
- DAG 논리 그래프를 물리적인 실행 계획으로 변환한다.
- 실행 그래프를 여러 stage 로 분리하며, 각 stage 는 여러 개의 task 로 구분된다. 각 task 들을 각 클러스터로 전송된다.

### 익스큐터

- 시작되면, 드라이버에 등록된다.
- 각 익스큐터는 task 를 실행하고 RDD 데이타를 저장한다.
- 사용자 프로그램에서 캐쉬하는 RDD 를 저장한다.

### 공유 변수

- 어큐뮬레이터
	- 쓰기 전용 변수,
	- 캐쉬되어 있던 RDD 가 삭제되어, 재 연산이 수행된다면 중복 연산이 발생할 수 있다.
- 브로드캐스트
	- 크기가 큰, 읽기 전용의 값을 모든 작업 노드에 전송하기 위하여 사용된다.

### 성능 고려 사항

- 병렬화 수준을 알맞게 조정
- 성능을 위해 직렬화 라이브러리 사용 가능 ( kyro )
- 메모리 관리
- 하드웨어 프로비저닝
